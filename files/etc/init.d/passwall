#!/bin/bash /etc/rc.common
# procd init script for sing-box

START=99
USE_PROCD=1

start_service() {
	if ! ip route show table 100 | grep -q 'local default dev lo'; then
		# 如果路由表不存在，则添加路由表和规则
		ip route add local default dev lo table 100 2>/dev/null
		ip rule add fwmark 1 table 100 2>/dev/null
		# 局域网流量走passWall
		iptables -t mangle -N passWall 2>/dev/null
		# 本机流量走passWallSelf
		iptables -t mangle -N passWallSelf 2>/dev/null
		# 局域网设备白名单中的ip直连
		while IFS= read -r line; do
			# 检查是否符合IP地址或CIDR格式
			if [[ $line =~ ^([0-9]{1,3}\.){3}[0-9]{1,3}(/([0-9]{1,2}))?$ ]]; then
				# 将符合格式的数据添加到iptables规则中
				iptables -t mangle -A passWall -d "$line" -j RETURN 2>/dev/null
				iptables -t mangle -A passWallSelf -d "$line" -j RETURN 2>/dev/null
			fi
		done </usr/local/etc/passWall/rules/局域网设备白名单.txt
		# 所有非53端口直连
		lanIPS=$(ip -o -f inet addr show |grep lan |awk '/scope global/ {print $4}')
		iptables -t mangle -A passWall -d "$lanIPS" -p tcp ! --dport 53 -j RETURN 2>/dev/null
        iptables -t mangle -A passWall -d "$lanIPS"  -p udp ! --dport 53 -j RETURN 2>/dev/null
        iptables -t mangle -A passWallSelf -d "$lanIPS"  -p tcp ! --dport 53 -j RETURN 2>/dev/null
        iptables -t mangle -A passWallSelf -d "$lanIPS"  -p udp ! --dport 53 -j RETURN 2>/dev/null
        # 其余流量走7894端口透明代理
        iptables -t mangle -A passWall -p tcp -j TPROXY --on-port 7894 --tproxy-mark 1 2>/dev/null
        iptables -t mangle -A passWall -p udp -j TPROXY --on-port 7894 --tproxy-mark 1 2>/dev/null
        iptables -t mangle -A passWallSelf  -j RETURN -m mark --mark 2 2>/dev/null
        iptables -t mangle -A passWallSelf -p tcp -j MARK --set-mark 1 2>/dev/null
        iptables -t mangle -A passWallSelf -p udp -j MARK --set-mark 1 2>/dev/null
        iptables -t mangle -A PREROUTING -j passWall 2>/dev/null
        iptables -t mangle -A OUTPUT -j passWallSelf 2>/dev/null
	fi
	
	procd_open_instance
	procd_set_param command /usr/local/bin/passWall run -D /usr/local/etc/passWall
	procd_set_param respawn
	procd_set_param file /var/run/passWall.pid
	procd_set_param stdout 1
	procd_set_param stderr 1
	procd_close_instance
}

stop_service() {
	# 删除自定义链中的规则
	iptables -t mangle -F passWall 2>/dev/null
	iptables -t mangle -F passWallSelf 2>/dev/null
	# 删除自定义链
	iptables -t mangle -X passWall 2>/dev/null
	iptables -t mangle -X passWallSelf 2>/dev/null
	# 删除在 PREROUTING 和 OUTPUT 链中添加的规则
	iptables -t mangle -D PREROUTING -j passWall 2>/dev/null
	iptables -t mangle -D OUTPUT -j passWallSelf 2>/dev/null
	# 删除路由表和规则
	if ip route show table 100 | grep -q 'local default dev lo'; then
		ip route del local default dev lo table 100 2>/dev/null
		ip rule del fwmark 1 table 100 2>/dev/null
	fi
	procd_close_instance
}
